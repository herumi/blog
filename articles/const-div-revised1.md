---
title: "å®šæ•°é™¤ç®—æœ€é©åŒ–å†è€ƒ1"
emoji: "ğŸ“–"
type: "tech"
topics: ["æ•´æ•°", "é™¤ç®—", "é€†æ•°ä¹—ç®—"]
published: true
---
## æ•´æ•°ã®é™¤ç®—
[æœ‰é™ä½“ã®å®Ÿè£…](https://zenn.dev/herumi/articles/finite-field-01-add)ã®è©±ã§ã¯åŠ æ¸›ä¹—ç®—ã¯ã—ã¦ã„ã¾ã—ãŸãŒã€é™¤ç®—ã¯ã‚„ã£ã¦ã¾ã›ã‚“ã§ã—ãŸã€‚
é™¤ç®—ã‚’é¿ã‘ã‚‹ãŸã‚ã«[Montgomeryä¹—ç®—](https://zenn.dev/herumi/articles/finite-field-03-mul)ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã—ãŸãŒã€é™¤ç®—ãŒå¿…è¦ã«ãªã‚‹å ´é¢ã¯ã©ã†ã—ã¦ã‚‚ã‚ã‚Šã¾ã™ã€‚
ã“ã“ã§ã¯æ‰‹å§‹ã‚ã«uint32_tã‚’å¯¾è±¡ã¨ã—ãŸã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å®šæ•°é™¤ç®—æœ€é©åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## å®šæ•°é™¤ç®—ã®æœ€é©åŒ–ã®ã‚¢ã‚¤ãƒ‡ã‚¢
`uint32_t`ãªã©ã®ç¬¦å·ãªã—æ•´æ•° $n$ ã‚’åŒã˜ãç¬¦å·ãªã—æ•´æ•° $d$ ã§é™¤ç®—ã™ã‚‹ã“ã¨ã‚’è€ƒãˆã¾ã™ã€‚ã“ã®ã¨ãä½™ã‚Šã¯åˆ‡ã‚Šæ¨ã¦ã¾ã™ã€‚
ã“ã“ã§ã¯Pythonã®é™¤ç®—è¨˜å·`//`ã‚’ä½¿ã£ã¦ $n \texttt{//} d$ ã¨æ›¸ãã“ã¨ã«ã—ã¾ã™ã€‚

$$
n \texttt{//} d := \mathrm{floor}(n/d).
$$

å¤§æŠµã®CPUã¯æ•´æ•°ã®è«–ç†å³ã‚·ãƒ•ãƒˆå‘½ä»¤ã‚’æŒã¡ã€ãã‚Œã«ã‚ˆã‚Š2ã¹ãã®æ•´æ•° $m=2^a$ ã«ã‚ˆã‚‹é™¤ç®—ã¯é«˜é€Ÿã«å®Ÿè¡Œã§ãã¾ã™ã€‚

$$
n \texttt{//} 2^a = n \texttt{>>} a.
$$

ãã“ã§å‰ã‚‚ã£ã¦ $1/d$ ã«è¿‘ããªã‚‹ã‚ˆã†ãªæ•´æ•° $c$ ã¨2ã¹ãã®æ•´æ•° $m$ ã‚’é¸ã³ã¾ã™ã€‚

$$
1/d \sim c / m.
$$

ãã—ã¦ $n \texttt{//} d \sim (n \times c)/m = (n \times c)\texttt{>>}a$ ã¨é™¤ç®—ã‚’ä¹—ç®—1å›ã¨å³ã‚·ãƒ•ãƒˆ1å›ã«å¤‰æ›ã™ã‚‹ã®ãŒå®šæ•°é™¤ç®—ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã€‚
1970å¹´ä»£ã‹ã‚‰ææ¡ˆã•ã‚Œ, Barret Reductionã¨å‘¼ã°ã‚Œã‚‹æ‰‹æ³•ã®è«–æ–‡  "Implementing the Rivest Shamir and Adleman Public Key Encryption Algorithm on a Standard Digital Signal Processor"(Barret, CRYPTO'86) ãŒæœ‰åã§ã™ã€‚
è¿‘ä¼¼ãªã®ã§ã©ã†ã†ã¾ã $c$ ã‚„ $a$ ã‚’ã¨ã‚‹ã¨èª¤å·®ãŒå°ã•ããªã‚‹ã‹ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚
ãã—ã¦["Division by Invariant Integers using Multiplication"(Granlund, Montgomery, SIGPLAN 1994)](https://gmplib.org/~tege/divcnst-pldi94.pdf) ã¨ãã®æ”¹å–„ç‰ˆã€Hacker's Delight 1st. editionã€(Warren, 2002)ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒGCC/Clang/Visual Studioãªã©ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆã¨æ€ã‚ã‚Œã¾ã™ï¼‰ã€‚

## ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®å‡ºåŠ›ä¾‹
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®å‡ºåŠ›ä¾‹ã‚’ã„ãã¤ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```cpp
#include <stdint.h>

uint32_t div3(uint32_t x)
{
    return x/3;
}

uint32_t div7(uint32_t x)
{
    return x/7;
}
```

```nasm
; x64
; gcc-14 a.c -S -masm=intel -O3
div3:
    mov eax, edi
    mov edx, 2863311531
    imul    rax, rdx
    shr rax, 33
    ret

div7:
    mov eax, edi
    imul    rax, rax, 613566757
    shr rax, 32
    sub edi, eax
    shr edi
    add eax, edi
    shr eax, 2
    ret
```

```nasm
; AArch64
; clang-18 --target=aarch64 -O3 -S a.c
div3:
    mov w8, #43691
    movk    w8, #43690, lsl #16
    umull   x8, w0, w8
    lsr x0, x8, #33
    ret

div7:
    mov w8, #18725
    movk    w8, #9362, lsl #16
    umull   x8, w0, w8
    lsr x8, x8, #32
    sub w9, w0, w8
    add w8, w8, w9, lsr #1
    lsr w0, w8, #2
    ret
```

ã„ãã¤ã‹ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ãŒç™»å ´ã—ã¦ã„ã¾ã™ã€‚
ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®è©³ç´°ã¯å¾Œè¿°ã—ã¾ã™ãŒã€x64ã®div3ã«ç¾ã‚Œã‚‹ `2863311531` ã¯16é€²æ•°ã§ `0xaaaaaaab` ã§ã‚ã‚Šã€ã“ã‚Œã¯AArch64ã®div3ã®`43691 + (43690<<16)`ã¨åŒã˜ã§ã™ã€‚
x64ã®div7ã®`613566757`ã‚‚AArch64ã®div7ã®`18725+(9362<<16)`ã«ç­‰ã—ãã€åŒã˜å®šæ•°é™¤ç®—æœ€é©åŒ–æ‰‹æ³•ã‚’ç”¨ã„ã¦ã„ã‚‹ã“ã¨ãŒä¼ºã‚ã‚Œã¾ã™ã€‚

## å®šæ•°ã®æ±‚ã‚æ–¹
ä»Šå›ã¯["Integer division by constatns: optimal bounds" (Lemire, Barlett, Kaser, 2020)](https://arxiv.org/abs/2012.12369)ã‚’å‚è€ƒã«ã—ã¤ã¤ã€å®šå¼åŒ–ã—ã¾ã—ã‚‡ã†ã€‚

ã¾ãšè¨˜å·ã‚’æº–å‚™ã—ã¾ã™ã€‚$M$ ã‚’1ä»¥ä¸Šã®æ•´æ•°ã€å‰²ã‚‹æ•° $d \in [1, M]$ ã‚’å®šæ•°ã¨ã—ã¾ã™ã€‚
éè² ã®æ•´æ•° $a$, $b$ ã«å¯¾ã—ã¦ $a$ ã‚’ $b$ ã§å‰²ã£ãŸä½™ã‚Šã‚’ $a \texttt{\%} b$ ã¨æ›¸ãã¾ã™ã€‚
ãã‚Œã‹ã‚‰å¤©ä¸‹ã‚Šçš„ã« $M_d$ ã‚’ $d$ ã§å‰²ã£ã¦ä½™ã‚ŠãŒ$d-1$ ã«ãªã‚‹ $M$ã‚’è¶Šãˆãªã„æœ€å¤§ã®æ•´æ•°ã¨ã—ã¾ã™ã€‚

$$
M_d:=\max \Set{n \in [1, M] | n \texttt{\%} d = d-1}=M-((M+1)\texttt{\%}d).
$$

ãªãœã€ã“ã‚“ãªæ•°å­—ã‚’å®šç¾©ã™ã‚‹ã‹ã¯ã“ã®å¾Œèª¬æ˜ã—ã¾ã™ã€‚

**å®šç†**
æ•´æ•° $m \ge d$ ã‚’ã¨ã‚Šã€$c :=  \mathrm{ceil}(m/d)=(m+d-1) \texttt{//} d$, $e := d c - m$ ã¨ã—ã¾ã™ã€‚
ã‚‚ã— $e M_d < m$ ãªã‚‰ã°å…¨ã¦ã®æ•´æ•° $x \in [0, M]$ ã«ã¤ã„ã¦ $x \texttt{//} d = (x c)\texttt{//}m$ ãŒæˆã‚Šç«‹ã¤ã€‚

**è§£èª¬**
ã¾ãš $e$ ã®æ§‹æˆæ³•ã‹ã‚‰ $0 \le e \le d-1 < m$ ã§ã™ã€‚
$1/d = c/(m+e)$ ãªã®ã§ $1/d$ ã‚’ $c/m$ ã§è¿‘ä¼¼ã—ãŸã¨ãã®èª¤å·®çš„ãªã‚‚ã®ãŒ $e$ ã§ã™ã€‚
ãã® $e$ ã«å¯¾ã—ã¦ $e M_d < m$ ã¨ã„ã†æ¡ä»¶ãŒæˆã‚Šç«‹ã¤2ã¹ãã® $m$ ãŒè¦‹ã¤ã‹ã‚Œã°ã€å®šæ•°é™¤ç®—ã‚’ä¹—ç®—+ã‚·ãƒ•ãƒˆæ¼”ç®—ã«ç½®ãæ›ãˆã‚‰ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ã¾ãšå®šç†ã®è¨¼æ˜ã‚’ã—ã¾ã—ã‚‡ã†ã€‚

**è¨¼æ˜**
$x \in [0, M]$ ã«å¯¾ã—ã¦ $(q, r) := \mathrm{divmod}(x, d)$ ã¨ã—ã¾ã™ã€‚ã¤ã¾ã‚Š $q := x \texttt{//} d$, $r := x \texttt{\%} d$ ã§ $x = qd + r$.
ã“ã®ã¨ã

$$
x c = q d c + r c = q (m + e) + r c = q m + (q e + r c).
$$

$y:=q e + r c$ ã¨ãŠãã¨ã€ã‚‚ã— $0 \le y < m$ ãªã‚‰ã° $(x c) \texttt{//} m = q = x \texttt{//} d$ ã¨ãªã‚Šè¨¼æ˜ãŒå®Œäº†ã—ã¾ã™ã€‚ãã“ã§ $y$ ã‚’ $d$ å€ã—ã¦

$$
f(x):=y d = (q e + r c)d = (x - r)e + r(m + e) = e x + m r
$$

ã¨ã—ã¦ $x$ ãŒ $[0, M]$ ã‚’å‹•ã„ãŸã¨ãã® $f(x)$ ã®æœ€å¤§å€¤ $B:=\max f(x)$ ã‚’è€ƒãˆã¾ã—ã‚‡ã†ã€‚
$r=x \texttt{\%} d$ ã¯ $x$ ã«ä¾å­˜ã—ã¦å‹•ãã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
$(q_0, r_0):=\mathrm{divmod}(M, d)$ ã¨ã—ã¾ã™ã€‚

*$(x,r)$ã®ã¨ã‚Šå¾—ã‚‹ç¯„å›²*
![xã¨rã®ã¨ã‚Šå¾—ã‚‹ç¯„å›²](/images/range-x-r.png =600x)

$x$ ãŒ0ã‹ã‚‰ $M$ ã¾ã§å¢—ãˆã‚‹ã¨ãã€$r$ ã¯ $[0, d-1]$ ã®ç¯„å›²ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚
$M_d$ ã¯ $x\texttt{\%} d$ ãŒ $d-1$ ã«ãªã‚‹ã¨ãã®æœ€å¤§ã® $x$ ã§ã—ãŸã€‚
$m$ ã¨ $e$ ã¯0ä»¥ä¸Šã®å®šæ•°ãªã®ã§ $f(x)$ ãŒæœ€å¤§å€¤ã‚’å–ã‚‹ã®ã¯ $(x,r)=(M_d,d-1)$ ã‹ $(M,r_0)$ ã®ã©ã¡ã‚‰ã‹ã§ã™ã€‚

### $M_d=M$ ã®ã¨ã
$r_0 = d-1$ ãªã®ã§ $B=f(M_d) = e M_d + m (d-1)$.
ä»®å®š $e M_d < m$ ã‚ˆã‚Š $B < m + m d - m = m d$. ã‚ˆã£ã¦ $\max(y) = \max f(x)/d = m$ ãŒç¤ºã›ã¾ã—ãŸã€‚

### $M_d < M$ ã®ã¨ã
æœ€å¤§å€¤ã‚’ã¨ã‚‹å€™è£œã¯2å€‹ $B_1:=f(M_d)=e M_d + m(d-1)$ ã‹ $B_2:=f(M)= eM + m r_0$ ã§ã™ã€‚
$B_1$ ã¯ $M_d=M$ ã®ã¨ãã¨åŒã˜ãªã®ã§ $B_2$ ã‚’è€ƒãˆã¾ã™ã€‚$B_2 < B_1$ ã‚’ç¤ºã›ã° $B=\max(B_1,B_2)=B_1$ ã¨ãªã‚Šã¾ã™ã€‚

$M_d < M$ ã¤ã¾ã‚Š $r_0 \le d-2$ ã‹ã¤ $M= M_d + 1 + r_0$ ã‚’ä»£å…¥ã™ã‚‹ã¨

$$
\begin{align*}
B_1-B_2&=(d-1-r_0)m - e(M - M_d)=(d-1-r_0)m - e(1 + r_0)\\
& \ge (d-1-(d-2)) m - e(1 + d-2) = m - e d + e \ge d(c - e) \ge 0.
\end{align*}
$$

$c \ge e$ ã¯ $e M_d < m$ ã¨ $d-1 \le M_d$ ã‹ã‚‰ $e(d-1) < m = c d - e$ ã‹ã‚‰å¾“ã„ã¾ã™ã€‚
ã„ãšã‚Œã®ã¨ãã‚‚ $B=\max f(x) = f(M_d) < m d$ ãŒç¤ºã›ã¾ã—ãŸã€‚

é•·ããªã£ã¦ã®ã§ã²ã¨ã¾ãšã“ã“ã¾ã§ã€‚
