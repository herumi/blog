---
title: "複数の有限体の要素の逆数をまとめて計算する"
emoji: "🧮"
type: "tech"
topics: ["有限体", "逆元"]
published: false
---
## 初めに

有限体の要素の逆数（逆元）操作は重たい処理です。
ここでは複数（$n$ 個）の要素の逆数をまとめて計算することで高速化する方法を紹介します。

## 2個の場合
$a$, $b$ を有限体の要素とします。求めたいものは $1/a$, $1/b$ です。
ここで、$1/a=b/ab$, $1/b=a/ab$ なので、まず $ab$ の逆数 $1/ab$ を求めてから $b$ 倍, $a$ 倍すると $1/a$, $1/b$ が求まります。
演算コストは1回の乗算を $M$, 1回の逆数計算を $I$ とすると $3M+I$ です。
BLS12-381の曲線では$I$ が $M$ より100倍前後、重たいので2回逆数を求める $2I$ に比べて約半分のコストとなります。

## 3個の場合
$a$, $b$, $c$ を有限体の要素とします。2個の場合と同様に考えると $abc$ を求めてその逆数 $1/abc$ を計算し、$bc$, $ac$, $ab$ を掛けて $1/a$, $1/b$, $1/c$ を求めればよいです。演算コストは $4M+I$.

## 4個以上の場合
$n=2$ や $n=3$ が簡単だったので一般化も容易そうに思いますが、$n=4$ で少し戸惑います。$a$, $b$, $c$, $d$ に対して $1/abcd$ を計算すると、$bcd$, $acd$, $abc$ が必要になります。
計算量を減らすために共通部分を探すと、$bc$ を求めたら、$(bc)d$, $a(bc)$ は1回ずつの乗算、$acd$ は共通項が無いので2回の乗算です。このやり方では $n$ が増えると大変そうです。
$n$ が大きくなっても同じ形の処理ができるように方法を少し変えましょう。
$ab$, $abc$ を計算しておき $1/abcd$ が求まったところで
- $abc \times 1/abcd=1/d$,
- $ab \times (d \times 1/abcd)=1/c$,
- $a \times (cd \times 1/abcd)=1/b$,
- $bcd \times 1/abcd = 1/a$

としましょう。これなら一つあたり2回の乗算ですみます。

## 一時バッファを用意する
より一般的に $n$ 個の有限体の要素 $x_0$, $x_1, \dots, x_{n-1}$ が与えられたとします。
$n$ 個のバッファ $T$ を用意し、$x_0$, $x_0 x_1$, $x_0 x_1 x_2, \dots, x_0 \cdot \dots \cdot x_{n-1}$ と先頭から順次掛けたものを保持します。

$i$|0|1|2|...|$n-2$|$n-1$
-|-|-|-|-|-|-
$T[i]$|$x_0$|$x_0 x_1$|$x_0 x_1 x_2$|...|$x_0 \cdot \dots \cdot x_{n-2}$|$x_0 \cdot \dots \cdot x_{n-1}$

このテーブル作成のコストは $(n-1)M$ です。
そして $T[n-1]$ の逆数 $t=1/(x_0 \cdot \dots \cdot x_{n-1})$ を計算し、一つ前の $T[n-2]=x_0 \cdot \dots \cdot x_{n-2}$ と掛けると $1/x_{n-1}$ が求まります。
$t$ に $x_{n-1}$ を掛けると $t ← t x_{n-1} = 1/(x_0 \cdot \dots \cdot x_{n-2})$ として $T[n-3]=x_0 \cdot \dots \cdot x_{n-3}$ を掛けて $1/x_{n-2}$.
以下同様に $t$ を更新しつつ、後ろから前にテーブルの値を掛けていくと全ての逆数が求まります。
演算コストは大体 $3nM + I$ です。$n$ が十分大きいときは一つあたりの逆数のコストは $3M$ に近づきます。

## 0を含むときの注意点
$x_0, \dots, x_{n-1}$ の中に0が含まれていると $T[n-1]=0$ となり、全ての逆数の値が0になってしまいます。
上記アルゴリズムを適用するときは $x_i=0$ ならスキップしなければなりません。また $x=1$ のときは逆数も $x=1$ なのでそのときをスキップすると少しだけ演算コストが減ります。

## 楕円曲線の複数の点のアフィン座標化
楕円曲線の点を[射影座標](https://zenn.dev/herumi/articles/projective-coordinate)や[ヤコビ座標](https://zenn.dev/herumi/articles/ecc-jacobi-coordinate)で表現しているとき、処理の最後でアフィン座標に変換する場合があります。
アフィン座標に変換するときは、$Z$ 座標の逆数などが必要になるので、複数の楕円曲線の点をアフィン座標化するには上記除算アルゴリズムを使うと高速化されます。
