---
title: "æº–åŒå‹æš—å·CKKSãã®4 Pythonã«ã‚ˆã‚‹å‹•ä½œç¢ºèª"
emoji: "ğŸ§®"
type: "tech"
topics: ["æº–åŒå‹æš—å·", "CKKS", "Python"]
published: true
---
## åˆã‚ã«
ä»Šå›ã¯æº–åŒå‹æš—å·CKKSã®ç†è§£ã‚’æ·±ã‚ã‚‹ãŸã‚ã«Pythonã«ã‚ˆã‚‹ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™([ckks.py](https://github.com/herumi/misc/blob/main/crypto/src/ckks.py))ã€‚å®Ÿç”¨çš„ãªã‚‚ã®ã§ã¯å…¨ãç„¡ã„ï¼ˆç‰¹ã«ãƒ¬ãƒ™ãƒ«ã®æ‰±ã„ã¯ã„ã„ã‹ã’ã‚“ï¼‰ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
è¨˜äº‹ä¸€è¦§ã¯[æº–åŒå‹æš—å·CKKSãã®1 å¤šé …å¼ç’°](https://zenn.dev/herumi/articles/ckks-ring-iso)

## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
å¤šé …å¼ã¨è¡Œåˆ—ã‚’æ‰±ã†ãŸã‚ã«numpyã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¾ã™ã€‚[æº–åŒå‹æš—å·CKKSãã®1 å¤šé …å¼ç’°](https://zenn.dev/herumi/articles/ckks-ring-iso)ã«å¾“ã£ã¦ã„ãã¤ã‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é©å½“ã«è¨­å®šã—ã¾ã™ã€‚
Pythonã®è¤‡ç´ æ•°ã¯`i`ã§ã¯ãªã`1j`ãªã®ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚æ·»ãˆå­—ãŒæ•°å¼ã¨ç•°ãªã£ã¦ã‚‹ã®ã¯ã”å‹˜å¼ã€‚
- $M$ : 2ã®ã¹ãä¹—
- $N:=M/2$
- $\xi:=exp(2 \pi i / M)$
- $S:=(\xi^{(2i+1)*j})$
- invS $:=S^{-1}$
- cycloPoly $:= X^N+1$

```python
import numpy as np
from numpy.polynomial import Polynomial as poly

def init(M: int, delta = 1000):
  global g_
  g_ = Param(delta)
  g_.M = M
  g_.N = M//2
  g_.halfN = g_.N//2
  g_.xi = np.exp(2 * np.pi * 1j / g_.M)

  # g_.S = (a_ij) = (((g_.xi^(2*i + 1))^j)
  for i in range(g_.N):
    root = g_.xi ** (2 * i + 1)
    row = []
    for j in range(g_.N):
      row.append(root ** j)
    g_.S.append(row)
  g_.invS = np.linalg.inv(g_.S)

  # M-th cyclotomic poly : phi_M(X) = X^N + 1
  g_.cycloPoly = poly([1] + [0] * (g_.N-1) + [1])
  return g_
```

## ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ»ãƒ‡ã‚³ãƒ¼ãƒ‰å®Ÿè£…ã®æº–å‚™
ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã¨ãƒ‡ã‚³ãƒ¼ãƒ‰é–¢æ•°ã«å¿…è¦ãªéƒ¨å“ã‚’æº–å‚™ã—ã¾ã™ã€‚

### $Ïƒ$ã¨$Ïƒ^{-1}$ã®å®Ÿè£…
$Ïƒ:â„‚[X] \rightarrow â„‚^N$ã¯å¤šé …å¼ã‚’å—ã‘å–ã‚Šã€$\xi^{2j+1}$ã®å€¤ã‚’ä»£å…¥ã—ã¦ä¸¦ã¹ãŸãƒ™ã‚¯ãƒˆãƒ«ã§ã—ãŸã€‚`init`ã§è¨­å®šã—ãŸè¡Œåˆ—$S$ã®æˆåˆ†$S[i][1]$ã‚’å¤šé …å¼ã§è©•ä¾¡ã—ã¦ãƒªã‚¹ãƒˆã‚’ä½œã‚Šã€ãã‚Œã‚’`np.array`ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚
é€†é–¢æ•°$Ïƒ^{-1}$ã¯$S$ã®é€†è¡Œåˆ—ã‚’`np.array`ã®`b`ã«æ›ã‘ã¦å¤šé …å¼ã¨ã¿ãªã—ã¾ã™ã€‚

```python
def sigma(p: poly):
  f = []
  for i in range(g_.N):
    f.append(p(g_.S[i][1]))
  return np.array(f)

def invSigma(b: np.array):
  return poly(np.dot(g_.invS, b))
```

### å¤šé …å¼ã®ä¿‚æ•°ã‚’ä¸¸ã‚ã‚‹`roundCoeff`
`roundCoeff`ã¯ä¿‚æ•°ã‚’å–ã‚Šå‡ºã—ã€`np.round`ã‚’é©ç”¨ã—ã¦ãƒªã‚¹ãƒˆã«ã—ã€çµæœã‚’å¤šé …å¼ã¨ã¿ãªã—ã¾ã™ã€‚
```python
def roundCoeff(p: poly):
  if type(p) == poly:
    p = p.convert().coef
  p = poly(list(map(np.round, p)))
  return p
```

### è¤‡ç´ æ•°ä¿‚æ•°å¤šé …å¼ã‚’å®Ÿæ•°ä¿‚æ•°å¤šé …å¼ã«å¤‰æ›ã™ã‚‹`getRealPoly`
è¤‡ç´ æ•°ä¿‚æ•°å¤šé …å¼ã®ã¾ã¾ã§ã‚‚æ§‹ã‚ãªã„ã®ã§ã™ãŒã€å®Ÿæ•°ä¿‚æ•°ã¨åˆ†ã‹ã£ã¦ã„ã‚‹ã¨ãã®ãŸã‚ã«ç°¡ç•¥åŒ–ã—ã¾ã™ã€‚å¿µã®ãŸã‚è™šéƒ¨ãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼ã«ã—ã¦ã„ã¾ã™ã€‚
```python
def getRealPoly(p: poly):
  def f(x):
    if x.imag != 0:
      raise('not zero')
    return x.real
  if type(p) == poly:
    p = p.convert().coef
  return poly(list(map(f, p)))
```

### $â„‚^N$ã‹ã‚‰$â„‚^{N/2}$ã¸ã®å°„å½±(projection)ã¨ãã®é€†å†™åƒ
é–¢æ•°$\pi:â„‚^N â†’ â„‚^{N/2}$ã¯å‰åŠã®è¦ç´ ã‚’å–ã‚Šå‡ºã™ã ã‘ã®é–¢æ•°`proj`ã§ã™ã€‚`halfN`ã¯`N/2`ã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```python
def proj(z: np.array):
  return z[0:g_.halfN]
```

$\pi$ã®é€†é–¢æ•°`invProj`ã¯ã€å‰åŠã®è¦ç´ ã‚’é€†é †ã«ã—ã€è¤‡ç´ å…±å½¹ã‚’ã¨ã£ãŸã‚‚ã®ã‚’å‰åŠã«ãã£ã¤ã‘ãŸã‚‚ã®ã§ã—ãŸã€‚
```python
def invProj(z: np.array):
  w = z.conjugate()[::-1]
  return np.hstack([z, w])
```

## Ecdã¨Dcdã®å®Ÿè£…
ã“ã‚Œã‚‰ã®é–¢æ•°ã‚’çµ„ã¿åˆã‚ã›ã¦[CKKSã®å¹³æ–‡ç©ºé–“ã¨ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ»ãƒ‡ã‚³ãƒ¼ãƒ‰](https://zenn.dev/herumi/articles/ckks-encoding#ckks%E3%81%AE%E5%B9%B3%E6%96%87%E7%A9%BA%E9%96%93%E3%81%A8%E3%82%A8%E3%83%B3%E3%82%B3%E3%83%BC%E3%83%89%E3%83%BB%E3%83%87%E3%82%B3%E3%83%BC%E3%83%89)ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
$Ecd(z)=[Î”Ïƒ^{-1}(\pi^{-1}(z))]$ã‚’ãã®ã¾ã¾å®Ÿè£…ã—ã¾ã™ã€‚

```python
def Ecd(z: np.array):
  p = invSigma(invProj(z)) * g_.delta
  p = roundCoeff(p)
  p = getRealPoly(p)
  return p
```
$Dcd(f)=\pi(Ïƒ(Î”^{-1}f))$ã‚‚åŒæ§˜ã§ã™ã€‚

```python
def Dcd(m: poly):
  return proj(sigma(m) / g_.delta)
```

å‹•ä½œç¢ºèªã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚[è«–æ–‡](https://eprint.iacr.org/2016/421)ã®9ãƒšãƒ¼ã‚¸å†’é ­ã‚’å¼•ç”¨ã€‚

![ã‚µãƒ³ãƒ—ãƒ«](/images/ckks-2016-421-p9.png)

```python
init(8, delta=64)
z = np.array([3+4j, 2-1j])
print(f'{z=}')
m = Ecd(z)
print(f'ecd={m}')
print(f'ded={Dcd(m)}')
```

```shell
z=array([3.+4.j, 2.-1.j])
ecd=160.0 + 91.0 x + 160.0 x**2 + 45.0 x**3
dcd=[3.008233+4.00260191j 1.991767-0.99739809j]
```

$M=8$, $Î”=64$ã¨ã—ã¦`init`ã‚’åˆæœŸåŒ–ã—ã€$z=(3+4i, 2-i)$ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€$160+91X+160X^2+45X^3$ã¨ãªã‚Šã€ãã‚Œã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨$[3.008233+4.00260191j, 1.991767-0.99739809j]$ã¨ã„ã†å€¤ã«ãªã‚Šã¾ã—ãŸã€‚
ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸæ™‚ç‚¹ã§å…ƒã«æˆ»ã‚‰ãšèª¤å·®ãŒã‚ã‚‹ã®ã‚’ç¢ºèªã§ãã¾ã™ã€‚

## éµç”Ÿæˆ
ä»Šå›ã®ç´¹ä»‹ã§ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚„ä¹±æ•°ã¯æ¥µã‚ã¦é›‘ï¼ˆ$M=8$ã¯å…¨ãå®‰å…¨ã§ãªã„ï¼‰ãªã®ã§ã€ã“ã“ã‚‚é›‘ã§ã™ã„ã¾ã›ã‚“ãŒã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```python
def KeyGen():
  # secret
  s = randHWT()
  # public
  a = randRQL()
  e = randDG()
  b = modPoly(-a * s + e)
  # evalutate
  n = g_.P * g_.qL
  ap = randRQL()
  ep = randDG()
  bp = modPoly(-ap * s + ep + g_.P * s * s)
  bp = modCoeff(bp, n)
  return (s, (b, a), (bp, ap))
```
`randHWT`ã¯$\Set{-1,0,1}$ã‹ã‚‰é©å½“ã«$N$å€‹é¸ã³ã€ãã‚Œã‚’ç§˜å¯†éµ`s`ã¨ã—ã¾ã™ã€‚`randRQL`ã‚„`randDG`ã¯é©å½“ã«`[-100,100]`, `[-3, 3]`ã‚ãŸã‚Šã®ä¹±æ•°ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
`b = modPoly(-a * s + e)`ã¨ã—ã¦`(b, a)`ãŒå…¬é–‹éµã€`(bp, ap)`ãŒè©•ä¾¡éµã§ã™ã€‚

## æš—å·åŒ–ã¨å¾©å·
$m \in R$ã®æš—å·åŒ–ã¯å…¬é–‹éµ$pk=(b,a)$ã«å¯¾ã—ã¦ä¹±æ•°$v, e_0, e_1$ã‚’é¸ã‚“ã§$c_0:=v+m+e_0$, $c_1:=va+e_1$ã‚’æ±‚ã‚ã‚Œã°ã‚ˆã„ã®ã§

```python
def Enc(pk, m):
  v = randZO()
  e0 = randDG()
  e1 = randDG()
  t0 = modPoly(v * pk[0] + m + e0)
  t1 = modPoly(v * pk[1] + e1)
  t0 = modCoeff(t0, g_.qL)
  t1 = modCoeff(t1, g_.qL)
  t0 = getRealPoly(t0)
  t1 = getRealPoly(t1)
  return (t0, t1)
```
å¾©å·ã¯$c=(b, a)$ã«å¯¾ã—ã¦ç§˜å¯†éµ$s$ã‚’ä½¿ã£ã¦$Dec(s, c)=b + a s$ãªã®ã§
```python
def Dec(sk, c):
  b, a = c
  t = modPoly(b + a * sk)
  ql = get_ql(g_.l)
  t = modCoeff(t, ql)
  return t
```

`z1= [0.+8.j 1.+0.j]`ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰â†’æš—å·åŒ–â†’å¾©å·â†’ãƒ‡ã‚³ãƒ¼ãƒ‰ã¨ã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã‚„ã¯ã‚Šèª¤å·®ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚
```pyhon
z1= [0.+8.j 1.+0.j]
m1= 500.0 + 2475.0 x + 4000.0 x**2 + 3182.0 x**3
c1.0= 539.0 + 2404.0 x + 3697.0 x**2 + 2970.0 x**3
  .1= 15.0 - 126.0 x - 109.0 x**2 + 193.0 x**3
dec c1= 497.0 + 2473.0 x + 4001.0 x**2 + 3190.0 x**3
dcd c1= [-0.00999556+8.00534570e+00j  1.00399556+3.34570186e-03j]
```

## æš—å·æ–‡ã®åŠ ç®—ã¨ä¹—ç®—

æš—å·æ–‡ã®åŠ ç®—ã¯è¦ç´ ã”ã¨ã®åŠ ç®—ãªã®ã§ç°¡å˜ã§ã™ã€‚
```python
def add(c1, c2):
  b1, a1 = c1
  b2, a2 = c2
  return (b1 + b2, a1 + a2)
```

ä¹—ç®—ã¯æš—å·æ–‡ã®æ§‹é€ ãŒå¢—ãˆã‚‹$(d_0, d_1, d_2)$ã‚’è¨ˆç®—ã—ã€è©•ä¾¡éµã‚’ä½¿ã£ã¦$(t_0, t_1):=[P^{-1} d_2 evk]$ã‚’è¨ˆç®—ã—ã€æœ€å¾Œã«$(d_0, d_1)+(t_0, t_1)$ã‚’æ±‚ã‚ã¾ã™ã€‚

```python
def mul(c1, c2, ek):
  b1, a1 = c1
  b2, a2 = c2
  d0 = modPoly(b1 * b2)
  d1 = modPoly(a1 * b2 + a2 * b1)
  d2 = modPoly(a1 * a2)
  t0 = modPoly(d2 * ek[0])
  t1 = modPoly(d2 * ek[1])
  t0 = roundCoeff(t0 / g_.P)
  t1 = roundCoeff(t1 / g_.P)
  t0 = d0 + roundCoeff(t0)
  t1 = d1 + roundCoeff(t1)
  return (t0, t1)
```

`z1= [0.+8.j 1.+0.j]`ã¨`z2= [5.+2.j 7.+6.j]`ã®æš—å·æ–‡`c1`, `c2`ã«å¯¾ã—ã¦`c1 + c2`ã‚„`c1 * c2 * c2`ã‚’è¨ˆç®—ã—ã¦ã¿ã¾ã—ãŸã€‚

```shell
z1= [0.+8.j 1.+0.j]
z2= [5.+2.j 7.+6.j]
m1= 500.0 + 2475.0 x + 4000.0 x**2 + 3182.0 x**3  # ecd(z1)
m2= 6000.0 + 2121.0 x - 2000.0 x**2 + 3536.0 x**3 # ecd(z2)
dcd1= [7.55057011e-05+8.00010306e+00j 9.99924494e-01+1.03061172e-04j] # dcd(m1)
dcd2= [4.9994439+2.00010306j 7.0005561+6.00010306j]                                    # dcd(m2)
c1.0= 539.0 + 2404.0 x + 3697.0 x**2 + 2970.0 x**3  # enc(m1)
  .1= 15.0 - 126.0 x - 109.0 x**2 + 193.0 x**3
c2.0= 6288.0 + 2252.0 x - 2095.0 x**2 + 3316.0 x**3 # enc(m2)
  .1= 12.0 - 166.0 x - 68.0 x**2 - 54.0 x**3
dec c1= 497.0 + 2473.0 x + 4001.0 x**2 + 3190.0 x**3 # dec(c1)
dec c2= 6000.0 + 2118.0 x - 1995.0 x**2 + 3538.0 x**3 # dec(c2)
dcd c1= [-0.00999556+8.00534570e+00j  1.00399556+3.34570186e-03j] # dcd(dec(c1))
dcd c2= [4.99590837+2.00439595j 7.00409163+5.99439595j] # dcd(dec(c2))
add.0= 6827.0 + 4656.0 x + 1602.0 x**2 + 6286.0 x**3 # add(c1, c2)
   .1= 27.0 - 292.0 x - 177.0 x**2 + 139.0 x**3
dec= 6497.0 + 4591.0 x + 2006.0 x**2 + 6728.0 x**3
dcd= [4.98591281+10.00974166j 8.00808719 +5.99774166j] # dec(add(c1, c2))
org= [5.+10.j 8. +6.j] # z1 + z2
mul.0= -3531567.0 + 10190964.0 x + 17534228.0 x**2 + 23647268.0 x**3 # mul(c1, c2)
   .1= 732188.0 + 349472.0 x - 1873330.0 x**2 + 513572.0 x**3
dec= -4541853.0 + 8099018.0 x + 16966140.0 x**2 + 24438938.0 x**3
dcd= [-16.09592124+39.97394933j   7.01221524 +6.04166933j] # dec(mul(c1, c2))
org= [-16.+40.j   7. +6.j] # z1 * z2
c3.0= -7.16206987e+10 + (4.83031357e+10) x + (6.23488876e+10) x**2 + # c1 * c2 * c2
(1.54530147e+11) x**3
  .1= 3.98552924e+09 + (1.44165597e+10) x - (1.42138081e+10) x**2 -
(2.40068148e+09) x**3
dcd c3= [-160.53731976+167.44293205j   12.90006264 +84.3506978j ] # dec(c1 * c2 * c2)
org= [-160.+168.j   13. +84.j] # z1 * z2 * z2
```
èª¤å·®ãŒã‚ã‚Šã¤ã¤è¨ˆç®—ã§ãã¦ã‚‹ã®ãŒè¦‹ãˆã¾ã™ã€‚

## ã¾ã¨ã‚
é›‘ãªå®Ÿè£…ã§ã¯ã‚ã‚Šã¾ã™ãŒã€åŸç†ã®ç†è§£ã®åŠ©ã‘ã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
