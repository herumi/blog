---
title: "æœ‰é™ä½“ã®å®Ÿè£…2ï¼ˆæ¸›ç®—ï¼‰"
emoji: "ğŸ§®"
type: "tech"
topics: ["æœ‰é™ä½“", "sub", "llvm", "x64"]
published: true
---
## åˆã‚ã«

å‰å›ã¯æœ‰é™ä½“ã®åŠ ç®—ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ä»Šå›ã¯æ¸›ç®—ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
å®Ÿè£…ã™ã‚‹é–¢æ•°ã¯

```cpp
// Unitã¯64ãƒ“ãƒƒãƒˆãªã‚‰uint64_t, 32ãƒ“ãƒƒãƒˆãªã‚‰uint32_t
// pz[] = (px[] - py[]) % pp[]
void fp_subN(Unit *pz, const Unit *px, const Unit *py, const Unit *py, const Unit *pp);
```
ã§ã™ã€‚è¨˜äº‹å…¨ä½“ã®ä¸€è¦§ã¯[æœ‰é™ä½“ã®å®Ÿè£…ä¸€è¦§](https://zenn.dev/herumi/articles/finite-field-01-add#%E6%9C%89%E9%99%90%E4%BD%93%E3%81%AE%E5%AE%9F%E8%A3%85%E4%B8%80%E8%A6%A7)å‚ç…§ã€‚

## LLVM DSLã«ã‚ˆã‚‹å®Ÿè£…

å‰å›[åŠ ç®—ã®ã€Œæœ€é©åŒ–ã¸ã®æº–å‚™ã€](https://zenn.dev/herumi/articles/finite-field-01-add#%E6%9C%80%E9%81%A9%E5%8C%96%E3%81%B8%E3%81%AE%E6%BA%96%E5%82%99)ã§ç´¹ä»‹ã—ãŸPythonã®ã‚³ãƒ¼ãƒ‰ã‚’å°‘ã—å¤‰å½¢ã—ã¾ã™ã€‚

```python
def select(cond, x, y):
  return x if cond else y

def fp_sub(x, y):
  x -= y
  return x + select(x < 0, p, 0)
```

ã“ã‚Œã‚’[å¤šå€é•·æ•´æ•°ã®å®Ÿè£…7ï¼ˆXbyakãƒ©ã‚¤ã‚¯ãªPython DSLã«ã‚ˆã‚‹asmã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼‰](http://localhost:8000/articles/bitint-07-gen-asm)ã§ç´¹ä»‹ã—ãŸDSLã§å®Ÿè£…ã—ã¾ã™ã€‚

```cpp
Operand pz(IntPtr, unit);
Operand px(IntPtr, unit);
Operand py(IntPtr, unit);
Operand pp(IntPtr, unit);
// pz[] = (px[] - py[]) % pp[]
// void fp_sub(Unit *pz, const Unit *px, const Unit *py, const Unit *py, const Unit *pp);
auto f = Function("fp_sub", Void, pz, px, py, pp);
beginFunc(f);
Operand x = loadN(px, N);
Operand y = loadN(py, N);
x = zext(x, bit + 1);
y = zext(y, bit + 1);
Operand v = sub(x, y);
Operand c = trunc(lshr(v, bit), 1);
Operand p = loadN(pp, N);
c = select(c, p, makeImm(bit, 0));
v = add(trunc(v, bit), c);
storeN(v, pz);
ret(Void);
endFunc();
```

```cpp
Operand pz(IntPtr, unit);
Operand px(IntPtr, unit);
Operand py(IntPtr, unit);
Operand pp(IntPtr, unit);
```
ãƒã‚¤ãƒ³ã‚¿å¤‰æ•°pz, px, py, ppã‚’å®šç¾©ã—ã¾ã™ã€‚

```cpp
auto f = Function("fp_sub", Void, pz, px, py, pp);
beginFunc(f);
...
endFunc();
```
é–¢æ•°fã‚’å®šç¾©ã—ã¾ã™ã€‚

```cpp
Operand x = loadN(px, N);
Operand y = loadN(py, N);
x = zext(x, bit + 1);
y = zext(y, bit + 1);
Operand v = sub(x, y);
```

px, pyã‹ã‚‰Nå€‹åˆ†ã®é…åˆ—ã®å€¤ã‚’èª­ã¿è¾¼ã¿ã€x, yã¨ã—ã¦`v = x - y`ã¨ã—ã¾ã™ã€‚`x = zext(x, bit + 1);`ã¨x, yã‚’1ãƒ“ãƒƒãƒˆå¢—ã‚„ã—ã¦ã„ã‚‹ã®ã¯å¼•ãç®—ã®ç¹°ã‚Šä¸‹ãŒã‚Šã‚’è¡¨ç¾ã™ã‚‹ãŸã‚ã§ã™ã€‚v = x - yã®æœ€ä¸Šä½ãƒ“ãƒƒãƒˆãŒç«‹ã£ã¦ã„ã‚Œã°x < yã ã£ãŸã¨ã„ã†ã“ã¨ã§ã™ã€‚

```cppp
Operand c = trunc(lshr(v, bit), 1); // (v >> bit) & 1
```
ã§ãã®1ãƒ“ãƒƒãƒˆã‚’å–ã‚Šå‡ºã—ã€

```cpp
Operand p = loadN(pp, N);
c = select(c, p, makeImm(bit, 0)); // c = c ? p : 0
```
ã§c = pã‹0ã¨ã—ã¾ã™ã€‚

```cpp
v = add(trunc(v, bit), c);
```
ã§1bitå¢—ã‚„ã—ãŸvã‚’å…ƒã®é•·ã•ã«æˆ»ã—ã¦cã‚’åŠ ç®—ã—ã¾ã™ã€‚ã‚ã¨ã¯`storeN`ã§ãƒ¡ãƒ¢ãƒªã«æ›¸ãæˆ»ã—ã¾ã™ã€‚
å¾Œã¯ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦LLVM-IRã‚’ç”Ÿæˆã—ã€å„CPUã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã”ã¨ã«æœ€é©ãªasmã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚Œã°OKã§ã™ã€‚ã“ã“ã¾ã§æº–å‚™ã—ã¦ãŠã‘ã°ç°¡å˜ã§ã™ã­ã€‚

## x64å‘ã‘æœ€é©åŒ–ã¨ç´°ã‹ã„è©±

x64ã§ã¯CFã‚’ä½¿ãˆã°ã‚ˆã„ã®ã§1bitå¢—ã‚„ã™å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚LLVMã«ãŠã‘ã‚‹select(x < 0, p, 0)ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã„ãã¤ã‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚
`x -= y`ã®å®Ÿè¡Œç›´å¾Œã¯CFãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼ˆx < 0ãªã‚‰CF=1ã€ãã†ã§ãªã‘ã‚Œã°0ï¼‰ã€‚äºˆã‚Tï¼ˆNå€‹ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã®çµ„ï¼‰ã«pã‚’loadã—ã¦ãŠãã€cmovncã§0ã‚’å…¥ã‚Œã¾ã™ã€‚cmovå‘½ä»¤ã¯å³å€¤ã‚’å–ã‚Œãªã„ã®ã§è£œåŠ©ãƒ¬ã‚¸ã‚¹ã‚¿ï¼ˆãŸã¨ãˆã°raxï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ä¸­ã®`_pm`ã®`p`ã¯ãƒ¬ã‚¸ã‚¹ã‚¿ã®é…åˆ—(packed)ã€`m`ã¯ãƒ¡ãƒ¢ãƒªã€`_pr`ã®`r`ã¯1å€‹ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’è¡¨ã—ã¾ã™ï¼ˆç§ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒ©ã®DSLã§ã®è¨˜å·ï¼‰ã€‚

```cpp
// X=[]ã«x -= yã®å®Ÿè¡ŒçµæœãŒå…¥ã£ã¦ã„ã‚‹(CF = x < 0 ? 1 : 0)
mov(eax, 0);
load_pm(T, pp); // T = []ã«pã®å€¤ã‚’å…¥ã‚Œã‚‹
cmovnc_pr(T, rax); // T = CF ? p : 0
add_pp(X, T);   // X += T
```

eaxã‚’0ã‚¯ãƒªã‚¢ã™ã‚‹ã®ã«`mov(eax, 0)`ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚é€šå¸¸ã‚ˆã‚Šãƒã‚¤ãƒˆé•·ã®çŸ­ã„`xor_(eax, eax)`ã‚’ä½¿ã„ã¾ã™ãŒï¼ˆmovã ã¨5ãƒã‚¤ãƒˆã€xorã ã¨2ãƒã‚¤ãƒˆï¼‰ã€ã“ã“ã§ã¯ç›´å‰ã«è¨­å®šã•ã‚ŒãŸCFã‚’å¤‰æ›´ã—ãŸããªã„ã®ã§movã‚’ä½¿ã„ã¾ã™ã€‚
ãªãŠxorã‚’ä½¿ã£ã¦0ã‚¯ãƒªã‚¢ã™ã‚‹å ´åˆã¯`xor_(rax, rax)`ã‚ˆã‚Šã‚‚`xor_(eax, eax)`ã®æ–¹ãŒã‚ˆã„ã§ã™ã€‚64bitç’°å¢ƒã§32bitã®æ¼”ç®—ã‚’ã™ã‚‹ã¨ä¸Šä½ãŒ0ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ãŸã‚ä¸¡è€…ã¯åŒã˜æŒ™å‹•ã ã‘ã‚Œã©ã‚‚ã€eaxã‚’ä½¿ã†æ–¹ãŒ1ãƒã‚¤ãƒˆçŸ­ã„ã‹ã‚‰ã§ã™ã€‚

æ¬¡ã«ã€Tã‚’0ã‚¯ãƒªã‚¢ã™ã‚‹ãªã‚‰cmovã‚ˆã‚Šã‚‚andã‚’ä½¿ã†æ–¹ãŒã‚ˆã„ã§ã™ã€‚ä¸Šè¨˜ã¨åŒç­‰ãªã‚³ãƒ¼ãƒ‰

```cpp
// X=[]ã«x -= yã®å®Ÿè¡ŒçµæœãŒå…¥ã£ã¦ã„ã‚‹(CF = x < 0 ? 1 : 0)
sbb(rax, rax);  // rax = CF ? -1 : 0
load_pm(T, pp); // T = []ã«pã®å€¤ã‚’å…¥ã‚Œã‚‹
and_pr(T, rax);
add_pp(X, T);   // X += T
```

`sbb(rax, rax)`ã¯`rax -= rax + CF`ã®æ„å‘³ãªã®ã§`rax = CF ? -1 : 0`ã¨ãªã‚Šã¾ã™ï¼ˆ-1ã¯å…¨ã¦ã®ãƒ“ãƒƒãƒˆãŒç«‹ã£ã¦ã„ã‚‹ã¨ã„ã†æ„å‘³ï¼‰ã€‚

SkylakeXã®å®Ÿè¡Œæ™‚é–“ï¼ˆAgneræ°ã®[Instruction tables](https://www.agner.org/optimize/instruction_tables.pdf)ï¼‰ã‚’è¦‹ã‚‹ã¨cmovç³»å‘½ä»¤ã‚ˆã‚Šã‚‚andå‘½ä»¤ã®æ–¹ãŒåŒæ™‚å®Ÿè¡Œã§ãã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã‹ã‚‰ã§ã™ã€‚

å‘½ä»¤|ã‚ªãƒšãƒ©ãƒ³ãƒ‰|Î¼ops fused|Î¼ops unfused|ãƒãƒ¼ãƒˆ|ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·|ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã®é€†æ•°
-|-|-|-|-|-|-
CMOVcc|r,r|1|1|p06|1|0.5
AND|r,r|1|1|p0156|1|0.25

åˆ¥ã®æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚ç´ æ•°pã®å€¤ã®é…åˆ—ã ã‘ã§ãªãã€0ã®å€¤ã®é…åˆ—ã‚‚ç”¨æ„ã—ã¦ãŠãã€CFã®å€¤ã«å¿œã˜ã¦Tã«èª­ã¿è¾¼ã‚€ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åˆ‡ã‚Šæ›ãˆã¾ã™ã€‚ã“ã†ã™ã‚‹ã¨å¿…è¦ãªä¸€æ¬¡ãƒ¬ã‚¸ã‚¹ã‚¿ã®ã‚»ãƒƒãƒˆTãŒä¸è¦ã«ãªã‚Šã¾ã™ã€‚NãŒå¤§ãã„ã¨ãã¯åŠ¹æœçš„ã§ã™ã€‚æ®‹å¿µãªãŒã‚‰fp_addã«ã¤ã„ã¦ã¯ã“ã®æ‰‹æ³•ã¯ä½¿ãˆã¾ã›ã‚“ã€‚

```cpp
// X=[]ã«x -= yã®å®Ÿè¡ŒçµæœãŒå…¥ã£ã¦ã„ã‚‹(CF = x < 0 ? 1 : 0)
lea(rax, ptr[rip + zeroL]); // zeroã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
cmovc(rax, pp);   // X < 0 ? pp : 0
add_pm(X, rax);
store_mp(pz, X);
```

## pãŒãƒ•ãƒ«ãƒ“ãƒƒãƒˆã§ãªã„å ´åˆã®æœ€é©åŒ–

ã“ã“ã§ã€ŒpãŒãƒ•ãƒ«ãƒ“ãƒƒãƒˆã§ã‚ã‚‹ã€ã¨ã¯ç´ æ•°pã®ãƒ“ãƒƒãƒˆé•·ãŒUnitã®ãƒ“ãƒƒãƒˆã‚µã‚¤ã‚ºã®å€æ•°ï¼ˆ64ãƒ“ãƒƒãƒˆãªã‚‰64ï¼‰ã¨ã„ã†æ„å‘³ã¨ã—ã¾ã™ï¼ˆç§ã®ã“ã“ã ã‘ã®é€ èªï¼‰ã€‚
LLVM DSLã®ç¯€ã§ç´¹ä»‹ã—ãŸã‚ˆã†ã«ä»»æ„ã®ãƒ“ãƒƒãƒˆé•·ã®ç´ æ•°ã‚’è€ƒæ…®ã™ã‚‹ãªã‚‰ã€1ãƒ“ãƒƒãƒˆå¢—ã‚„ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ã€ãŸã¨ãˆã°N = 4ã§pãŒ255ãƒ“ãƒƒãƒˆã®ç´ æ•°ãªã‚‰ã€æœ€ä¸Šä½ãƒ“ãƒƒãƒˆãŒç©ºã„ã¦ã„ã‚‹ã®ã§å¢—ã‚„ã™å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ãƒ«ãƒ“ãƒƒãƒˆã‹å¦ã‹ã‚’è¡¨ã™ãƒ•ãƒ©ã‚°isFullBitã‚’ä½¿ã†ã¨fp_subã¯æ¬¡ã®ã‚ˆã†ã«æœ€é©åŒ–ã§ãã¾ã™ã€‚

```cpp
Operand x = loadN(px, N);
Operand y = loadN(py, N);
if (isFullBit) {
  x = zext(x, bit + 1);
  y = zext(y, bit + 1);
}
Operand v = sub(x, y);
Operand c;
if (isFullBit) {
  c = trunc(lshr(v, bit), 1);
  v = trunc(v, bit);
} else {
  c = trunc(lshr(v, bit - 1), 1);
}
Operand p = loadN(pp, N);
```

ã“ã®æœ€é©åŒ–ã¯fp_addã‚„fp_subã ã‘ã§ãªãæ§˜ã€…ãªå ´é¢ã«é©ç”¨ã§ãã¾ã™ã€‚
æ˜”ã¯pã‚’256ãƒ“ãƒƒãƒˆãªã©ã®ãƒ•ãƒ«ãƒ“ãƒƒãƒˆã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¢ç´¢ã—ã¦ã„ãŸã®ã§ã™ãŒã€ç§ãŸã¡ã®å®Ÿè£…è«–æ–‡[High-Speed Software Implementation of the Optimal Ate Pairing over Barreto-Naehrig Curves](https://eprint.iacr.org/2010/354)ä»¥é™ã¯ãƒ•ãƒ«ãƒ“ãƒƒãƒˆã§ãªã„ç´ æ•°ãŒä½¿ã‚ã‚Œã‚‹å ´é¢ãŒå¢—ãˆãŸã‚ˆã†ã«æ€ã„ã¾ã™ã€‚
1ãƒ“ãƒƒãƒˆæ¸›ã£ãŸã¨ã“ã‚ã§æ”»æ’ƒæ™‚é–“ã¯ç²¾ã€…åŠåˆ†ã«ã—ã‹æ¸›ã‚‰ãªã„ã‘ã‚Œã©ã‚‚ç¾åœ¨ã®å®Ÿè¡Œé€Ÿåº¦ã¯å‰²ã¨æ”¹å–„ã•ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚ãƒšã‚¢ãƒªãƒ³ã‚°ã§ã‚ˆãä½¿ã‚ã‚Œã‚‹BLS12-381æ›²ç·šã‚„é›»å­ç½²åã§ä½¿ã‚ã‚Œã‚‹ed25519ã‚‚ãƒ•ãƒ«ãƒ“ãƒƒãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
