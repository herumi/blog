---
title: "完全準同型暗号CKKSその2 エンコーディングとPythonによる実装"
emoji: "🧮"
type: "tech"
topics: ["完全準同型暗号", "CKKS", "エンコーディング"]
published: false
---
## 初めに
前回、多項式環とベクトル空間の同型対応を紹介しました。今回はそれを使ってCKKSの平文のエンコーディングと、Pythonによる簡単な実装を紹介します。

## 前回の復習
$M$を4以上の2のべきの形の整数、$\xi:=e^{2\pi i/M}$, $N:=M/2$としたとき$σ:ℂ[X]/(X^N+1) \rightarrow  ℂ^N$を$σ(f):=(f(\xi), f(\xi^3), \dots, f(\xi^{2N-1}))$で定義し、それが環同型となっていることを示しました。

## 複素共役
複素数$z=a+bi$（$a,b \in ℝ）$に対して、複素共役（きょうやく）を$conj(z):=a-bi$と書きます。複素共役は複素平面の$x$軸に対する線対称の操作です。markdownでチルダ$\tilde{z}$は表記しづらいので$conj$を使います。
複素数$z$, $w$の和や積の複素共役はそれぞれの複素共役です。

$$
\begin{align*}
conj(z+w)&=conj(z)+conj(w),\\
conj(zw)&=conj(z)conj(w).
\end{align*}
$$

実数$a$の複素共役は変化しません。

$$conj(a)=a.$$

さて、$\xi$について$conj(\xi)=\xi^{M-1}$です。よって$conj(\xi^u)=\xi^{M-u}$です。
前回の1の8乗根の例を見ても、

$$
\begin{align*}
conj(\xi)&=\xi^7,\\
conj(\xi^2)&=\xi^6,\\
conj(\xi^3)&=\xi^5,\\
conj(\xi^4)&=\xi^4
\end{align*}
$$
が見て取れます。

## 実数係数多項式環
$f$が実数係数多項式なら$conj(f(\xi^{2j-1}))=f(conj(\xi^{2j-1}))=f(\xi^{M-2j+1})$です。だから$σ(f)=(f(\xi^{2j-1}))_{j=1,\dots,N}$は$N$次元ベクトルのうち、前半の$N/2$個の成分だけで後半は前半を逆順にして複素共役をとったものです。

*実係数多項式$f$についての$σ(f)$*
![実係係数多項式の像](/images/conj-real-poly.png)

逆に複素数係数多項式$f \in ℂ[X]$について$conj(f(\xi^{2j-1}))=f(\xi^{M-2j+1})$ （※）を満たすと$f \in ℝ[X]$です。
なぜなら任意の$f \in ℂ[X]$は、ある$g, h \in ℝ[X]$を使って$f(X)=g(X)+ih(X)$と書けます。$t:=2j-1$とすると、

$$
conj(f(\xi^t))=conj(g(\xi^t)+ih(\xi^t))=g(\xi^{M-t})-ih(\xi^{M-t}).
$$
ここで仮定（※）より

$$
conj(f(\xi^t))=f(\xi^{M-t})=g(\xi^{M-t})+ih(\xi^{M-t}).
$$

両者が等しいので$h(\xi^{M-t})=0$。これが$t=1, 3, \dots, 2N-1$について成り立つので$h(X)=0$。これは$f \in ℝ[X]$を意味します。

そこで、$ℂ[X]$の前半だけを取り出す写像を定義します。

$$
π:  ℂ^N \ni (z_1, \dots, z_N) \mapsto (z_1, \dots, z_{N/2}) \in ℂ^{N/2}.
$$

この逆写像は一意には決まりませんが、前半から、後半を逆順の複素共役で復元する写像

$$
π^{-1}: ℂ^{N/2} \ni (y_1,...,y_{N/2}) \mapsto  (y_1,...,y_{N/2}, conj(y_{N/2}), .., conj(y_1)) \in  ℂ^N
$$

と定義します。すると$H:=π^{-1}(ℂ^{N/2}) \subseteq ℂ^N$は実数係数多項式全体$ℝ[X]$の$σ$による像$σ(ℝ[X])$に一致します。関係がややこしくなったので図示すると

*$ℂ[X]$と$ℝ[X]$の関係*
![CとRの関係](/images/real-poly-in-cn.png)

## CKKSのエンコードと平文空間
ようやくCKKSの平文空間を定義する準備が出来ました。$Δ$をスケール因子とします。
暗号化したい複素$N/2$次元ベクトル$z \in ℂ^{N/2}$をとり、$\pi^{-1}(z) \in H$の中で整数係数に丸めます。

$$
t:=round(\pi^{-1}(z)Δ).
$$