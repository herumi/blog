---
title: "楕円lifted ElGamal暗号の加法準同型性"
emoji: "🧮"
type: "tech"
topics: ["liftedElGamal暗号", "楕円曲線", "加法準同型暗号"]
published: false
---
## 初めに
前回、楕円曲線を使った公開鍵暗号[楕円ElGamal暗号](https://zenn.dev/herumi/articles/elgamal-encryption)を紹介しました。
この方式は暗号化したい数値をそのまま使えず、楕円曲線の点に埋め込まなければなりませんでした。lifted ElGamal暗号はその問題を改善する方法の一つです。
その方式とlifted ElGamal暗号が持つ加法性について紹介し、WebAssemblyによるサンプルを試します。

## 楕円ElGamal暗号の復習
$P$を楕円曲線の点、$G$を$P$を生成元とする位数$r$の巡回群とします。$G=\Set{0, P, 2P, \dots, (r-1)P}.$

$0$以上$r$未満の整数の集合$[0, r)$からランダムに整数$s$を一つとり、秘密鍵とします。$Q:=sP$が公開鍵です。
$G$の要素$M$を暗号化するには、$t ← [0, r)$をランダムにとり、公開鍵$Q$を使って$Enc(Q, M):=(M+tQ,tP)$とします。
暗号文$c:=(S,T)$に対して秘密鍵$s$を使って$Dec(s,c):=S-sT$で復号します。

## 楕円lifted ElGamal暗号
説明の前に一つ記号を導入します。$G$の点$xP$が与えられたときに$x \in [0, r)$を求める操作を$DLP(P, xP)=x$と書くことにします。DLPは離散対数問題を解く操作です。

楕円lifted ElGamal暗号の鍵生成はElGamal暗号と同じです。
$s← [0, r)$が秘密鍵で$Q:=sP$が公開鍵。

整数$m$を暗号化するには、$M:=mP$として楕円曲線の点を作り、それをElGamal暗号化します。つまり、$t ← [0, r)$をランダムにとり

$$
Enc(Q, m):=(mP+tQ, tP).
$$

暗号文$c=(S, T)$の復号は$dec(s, c):=S-sT$でElGamal暗号文を復号したあと、結果を$P$に関してDLPで解きます。

$$
Dec(s, c):=DLP(P, dec(s, c)).
$$

## 楕円lifted ElGamal暗号の妥当性
$m$を暗号化して作った暗号文$c$を復号したら元に戻ることを確認します。
$M:=mP$をElGamal暗号で暗号化して、復号するので$M$に戻ります。最後に$DLP(P, M)=DLP(P, mP)=m$とDLPを解いて元に戻ります。

まずはここで疑問に思うでしょう。暗号の安全性のためにDLP困難な群を使っているのに、復号時にDLPを解くのはナンセンスでは？
それは当然の疑問なのですが、$m$が32ビット程度の整数値なら力業でDLPを解いても実用的な速度が得られます。DLPが解ける範囲なら使えるのです。詳細はまたの機会に紹介します。
そして、楕円lifted ElGamal暗号は平文の範囲が狭められる、復号時に小さなDLPを解かなければならないという制約があるのですが、その代わりに次節で紹介する興味深い性質を持っています。

## 加法準同型
$m_1$, $m_2$を（最大32ビット程度の）平文、$c_i:=Enc(Q, m_i;t_i)=(S_i,T_i)$を対応する暗号文としましょう。ここで暗号時に利用した乱数$t_i$を明示しています。
暗号文$c_1$と$c_2$の足し算を、要素ごとに（$G$の演算として）足すという意味で定義します。

$$
c:=c_1+c_2:=(S_1+S_2,T_1+T_2)  \cdots \text{（※）}.
$$

このようにして作った$c=(S, T)$を観察します。$S_i=m_i P + t_i Q$, $T_i=t_i P$なので

$$
\begin{align*}
S&=(m_1 P + t_1Q) + (m_2 P + t_2Q) = (m_1 + m_2)P + (t_1+t_2)Q,\\
T&=t_1 P + t_2 P = (t_1+t_2)P.
\end{align*}
$$

$t:=t_1+t_2$とすると$c=((m_1+m_2)P+t Q, tP) = Enc(Q, m_1+m_2;t).$ つまり

$$
Enc(Q, m_1;t_1)+Enc(Q,m_2;t_2)=Enc(Q,m_1+m_2;t_1+t_2).
$$

これは$m_1$の暗号文と$m_2$の暗号文を（※）の意味で足すと、$m_1+m_2$の暗号文になるという意味です。復号しなくても暗号文同士の演算ができたのです。
更に$c=(S,T)$に対して$-c:=(-S,-T)$とすると$c+(-c)=(0, 0)$となり、これは平文0を乱数0で暗号化した暗号文$Enc(Q, 0;0)$です。
したがって、暗号文の空間は（※）を加算、$(0,0)$を単位元とする加法群となります（厳密には乱数だけが異なる暗号文は同一視する必要がある）。
このような性質を加法準同型といいます。公開鍵$Q$と乱数を省略すると

$$
Enc(m_1)+Enc(m_2)=Enc(m_1+m_2).
$$

## WebAssemblyによる実装例
数式ばかりでは飽きるので[she-wasm](https://github.com/herumi/she-wasm)で例を確認しましょう。