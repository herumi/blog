---
title: "å®šæ•°é™¤ç®—æœ€é©åŒ–å†è€ƒ2"
emoji: "ğŸ“–"
type: "tech"
topics: ["æ•´æ•°", "é™¤ç®—", "é€†æ•°ä¹—ç®—"]
published: false
---
## æ•´æ•°ã®å®šæ•°é™¤ç®—æœ€é©åŒ–ã®è©±ã®ç¶šãã‚’ã—ã¾ã™ã€‚

## [å‰å›](https://zenn.dev/herumi/articles/const-div-revised1)ã®ã¾ã¨ã‚
$M$ ã‚’1ä»¥ä¸Šã®æ•´æ•°ã€å‰²ã‚‹æ•° $d \in [1, M]$ ã‚’å®šæ•°ã¨ã—ã¾ã™ã€‚
$M_d:=M-((M+1)\texttt{\%}d)$ ã¨ã—ã¾ã™ã€‚
**å®šç†**
æ•´æ•° $A \ge d$ ã‚’ã¨ã‚Šã€$c :=  \mathrm{ceil}(A/d)=(A+d-1) \texttt{//} d$, $e := d c - A$ ã¨ã—ã¾ã™ã€‚
ã‚‚ã— $e M_d < A$ ãªã‚‰ã°å…¨ã¦ã®æ•´æ•° $x \in [0, M]$ ã«ã¤ã„ã¦ $x \texttt{//} d = (x c)\texttt{//}A$ ãŒæˆã‚Šç«‹ã¤ã€‚

## $A$ ã®æ¢ç´¢ã‚³ãƒ¼ãƒ‰

å®šç†è‡ªä½“ã¯ $A$ ãŒ2ã¹ãã§ãªã„æ•´æ•°ã§ã‚‚æˆã‚Šç«‹ã¡ã¾ã™ãŒã€å®Ÿéš›ã«åˆ©ç”¨ã™ã‚‹ã®ã¯ $A=2^a$ ã®å½¢ã§æ¢ã—ã¾ã™ã€‚

æ•´æ•°ã®ç¯„å›²ã‚’`uint32_t`ã«é™ã‚‹ãªã‚‰ã€$M=2^{32}-1$ ã§ $e < d \le M$ ãªã®ã§ $A=2^{64}$ ã¨ã™ã‚Œã° $e M_d < A$ ãŒæˆã‚Šç«‹ã¡ã€å®šç†ã‚’æº€ãŸã™ $A$ ã¯å­˜åœ¨ã—ã¾ã™ã€‚

ã‚‚ã—ã€$d$ ãŒ $2^{31}=\texttt{0x80000000}$ ä»¥ä¸Šãªã‚‰ã°ã€$x \in [0, M]$ ã«ã¤ã„ã¦ $x\texttt{//}d \in [0, 1]$ ãªã®ã§ $x \ge d$ ãªã‚‰1ã‚’è¿”ã™ã ã‘ã§ã‚ˆã„ã§ã™ã€‚

```cpp
// return x//d for d >= 0x80000000
uint32_t divd(uint32_t x)
{
    return x >= d_ ? 1 : 0;
}
```

ã—ãŸãŒã£ã¦ã€$d < \texttt{0x80000000}$ ã‚’ä»®å®šã—ã¾ã—ã‚‡ã†ã€‚
$A$ ã¯ $d$ ã‚ˆã‚Šå¤§ãã„2ã¹ãã®æ•´æ•°ã‹ã‚‰å§‹ã‚ã‚Œã°ã‚ˆã„ã®ã§ $a=\mathrm{ceil}(\log_2(d))$ ã¨ã—ã¦æ¡ä»¶ã‚’æº€ãŸã™ $a$ ã‚’æ¢ã—ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®é€šã‚Š

```cpp
static const uint32_t M = 0xffffffff;
bool init(uint32_t d)
{
    const uint32_t M_d = M - ((M+1)%d);
    assert(d < 0x80000000);
    for (uint32_t a = ceil_ilog2(d); a < 64; a++) {
        uint64_t A = uint64_t(1) << a;
        uint64_t c = (A + d - 1) / d;
        uint64_t e = d * c - A;
        if (e * M_d < A) { // find
           // (a, A, c) ãŒæ¬²ã—ã„ç­”ãˆ
           return true;
        }
    }
    return false;
}